---
import Layout from "../layouts/Layout.astro";
import RssIntro from "../components/sections/RssIntro.astro";
import RssFeeds from "../components/sections/RssFeeds.astro";
import { defaultSEO } from "../utils/seo";

const seoData = {
    ...defaultSEO,
    title: "Flux RSS - Mathieu Piton",
    description:
        "Découvrez les articles les plus intéressants que j'ai sélectionnés pour vous dans mes flux RSS. Des sujets variés allant du développement web aux dernières tendances technologiques.",
};

// Données par défaut pour les tests
const defaultItems = Array(9).fill({
    title: "Test Article",
    url: "https://example.com",
    pub_date: new Date().toISOString(),
    description: "Test Description",
    image_url: "https://placehold.co/600x400",
});

// Récupération des articles depuis l'API
const API_URL = import.meta.env.PUBLIC_API_URL || "http://localhost:8080";
let items = [];

// En mode test, utiliser directement les données par défaut
const isTestMode = import.meta.env.MODE === "test";

if (isTestMode) {
    items = defaultItems;
} else {
    try {
        const response = await fetch(`${API_URL}/api/rss?page=1&limit=9`);
        if (response.ok) {
            items = await response.json();
        } else {
            items = defaultItems;
        }
    } catch (error) {
        console.error("Erreur:", error);
        items = defaultItems;
    }
}

// Transformation des données pour correspondre à l'interface RssItem
const rssItems = items.map((item: any) => ({
    title: item.title || "Article sans titre",
    link: item.url || "#",
    description: item.description || "Pas de description disponible",
    pubDate: new Date(item.pub_date || Date.now()),
    imageUrl:
        item.image_url ||
        `https://placehold.co/600x400/grey/white/png?text=${encodeURIComponent(item.title || "Article")}`,
}));
---

<Layout seo={seoData}>
    <main class="min-h-screen bg-[var(--accent-color)] pt-24 pb-16">
        <RssIntro
            title="Mes flux RSS favoris"
            description="Découvrez les articles les plus intéressants que j'ai sélectionnés pour vous dans mes flux RSS. Des sujets variés allant du développement web aux dernières tendances technologiques."
        />
        <RssFeeds items={rssItems} />
    </main>
</Layout>
