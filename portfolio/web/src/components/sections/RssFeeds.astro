---
// Les articles sont chargés dynamiquement côté client pour toujours avoir les derniers articles
---

<section class="px-4 py-8 md:py-12">
  <div class="max-w-7xl mx-auto">
    <div id="articles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      <div id="loading-placeholder" class="col-span-full text-center py-8">
        <p class="text-text-main">Chargement des articles...</p>
      </div>
    </div>
    <div class="text-center">
      <button
        id="loadMore"
        class="bg-primary text-accent font-semibold px-8 py-4 rounded-lg hover:bg-primary-dark transition-colors duration-300"
        type="button"
      >
        Charger plus d'articles
      </button>
    </div>
  </div>
</section>

<script>
  const API_URL = 'https://api.mathieu-piton.com';
  const ITEMS_PER_PAGE = 9;
  let currentPage = 1;

  const container = document.getElementById('articles-container');
  const loadMoreBtn = document.getElementById('loadMore');
  const loadingPlaceholder = document.getElementById('loading-placeholder');

  async function loadArticles(page: number) {
    try {
      const res = await fetch(`${API_URL}/api/rss?page=${page}&limit=${ITEMS_PER_PAGE}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const items = Array.isArray(data) ? data : data.articles || [];
      return items.map((item: any) => ({
        title: item.title || 'Article sans titre',
        pubDate: new Date(item.pubDate || item.pub_date || Date.now()),
        link: item.link || item.url || '#',
        imageUrl:
          item.image_url ||
          item.imageUrl ||
          `https://placehold.co/600x400/grey/white/png?text=${encodeURIComponent(item.title || 'Article')}`,
      }));
    } catch (e) {
      console.error('Erreur chargement RSS:', e);
      return [];
    }
  }

  function formatDate(d: Date) {
    try {
      return d.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
    } catch {
      return '';
    }
  }

  function createCardHTML(item: { link: string; imageUrl: string; title: string; pubDate: Date }) {
    return `
<article class="bg-secondary rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 hover:-translate-y-1 group">
  <a href="${item.link}" target="_blank" rel="noopener noreferrer" class="block">
    <div class="relative h-48 overflow-hidden">
      <img src="${item.imageUrl}" alt="${item.title?.replace(/"/g, '&quot;')}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" />
    </div>
    <div class="p-6">
      <h3 class="text-xl font-heading font-semibold text-text-main mb-2 line-clamp-2" title="${item.title?.replace(/"/g, '&quot;')}">${item.title}</h3>
      <p class="text-sm text-gray-600 mb-4">${formatDate(item.pubDate)}</p>
      <span class="inline-block text-primary font-semibold group-hover:text-primary-dark transition-colors duration-300">Lire l'article<span class="sr-only">, ${item.title}</span></span>
    </div>
  </a>
</article>`;
  }

  // Charger les premiers articles au chargement de la page
  async function init() {
    const items = await loadArticles(1);
    loadingPlaceholder?.remove();
    if (items.length === 0) {
      container?.insertAdjacentHTML('beforeend', '<p class="col-span-full text-center text-text-main">Aucun article disponible</p>');
      return;
    }
    const html = items.map(createCardHTML).join('');
    container?.insertAdjacentHTML('beforeend', html);
  }

  init();

  loadMoreBtn?.addEventListener('click', async () => {
    loadMoreBtn.setAttribute('disabled', 'true');
    loadMoreBtn.textContent = 'Chargement…';
    const nextPage = currentPage + 1;
    const newItems = await loadArticles(nextPage);
    if (newItems.length === 0) {
      loadMoreBtn.textContent = 'Aucun autre article';
      return;
    }
    const html = newItems.map(createCardHTML).join('');
    container?.insertAdjacentHTML('beforeend', html);
    currentPage = nextPage;
    loadMoreBtn.removeAttribute('disabled');
    loadMoreBtn.textContent = "Charger plus d'articles";
  });
</script>
